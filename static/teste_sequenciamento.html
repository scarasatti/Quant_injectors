<h2>Status: <span id="status">Aguardando...</span></h2>
<button onclick="startSequenciamento()">Iniciar Sequenciamento (Jobs fixos)</button>

<script>
  const userId = "1";
  const jobIds = [1, 2, 3, ... 12];
  const sequencingDate = "2024-11-22T12:00:00";
  const machineAvailability = 100;

  let source;
  let sequencingDone = false;           // Flag booleana para conclus√£o
  let finalObjectiveValue = null;       // Armazena objetivo final

  function conectarSSE() {
    if (source) source.close();
    source = new EventSource(`/sequenciamento/sequenciamento/stream?user_id=${userId}`);
    document.getElementById("status").innerText = "Aguardando resposta do servidor...";

    // Evento SSE de mensagem
    source.onmessage = function(event) {
      if (event.data === "true") {  // supondo "true" indica fim
        sequencingDone = true;
        console.log("‚úÖ Evento final recebido via SSE.");
        source.close();  // Fecha SSE ao concluir:contentReference[oaicite:5]{index=5}

        // Atualiza status final se j√° temos o objetivo
        if (finalObjectiveValue !== null) {
          document.getElementById("status").innerText =
            `Sequenciamento finalizado. Objetivo: ${finalObjectiveValue}`;
        } else {
          document.getElementById("status").innerText = "Sequenciamento finalizado. (aguardando objetivo)";
        }
      } else {
        // Eventos intermedi√°rios de progresso
        document.getElementById("status").innerText = event.data;
        console.log("üîÑ Evento SSE:", event.data);
      }
    };

    // Tratamento de erro SSE
    source.onerror = function(error) {
      document.getElementById("status").innerText = "Erro na conex√£o com SSE";
      console.error("‚ùå Erro SSE:", error);
      source.close();
    };
  }

  async function startSequenciamento() {
    conectarSSE();  // inicia conex√£o SSE

    try {
      const url = `/sequenciamento/sequenciamento/solve?sequencing_date=${encodeURIComponent(sequencingDate)}&machine_availability=${machineAvailability}`;
      const response = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(jobIds)
      });

      const data = await response.json();
      finalObjectiveValue = data.objective_value;  // guarda valor objetivo

      if (!response.ok) {
        document.getElementById("status").innerText = `Erro: ${JSON.stringify(data)}`;
      } else {
        // Espera at√© receber o sinal de conclus√£o via SSE
        await new Promise(resolve => {
          const interval = setInterval(() => {
            if (sequencingDone) {
              clearInterval(interval);
              resolve();
            }
          }, 100);
        });
        // Agora sim, atualiza status final com o objetivo
        document.getElementById("status").innerText =
          `Sequenciamento finalizado. Objetivo: ${data.objective_value}`;
        console.log("üü¢ Resposta da API:", data);
      }

    } catch (err) {
      console.error("‚ùå Erro na requisi√ß√£o:", err);
      document.getElementById("status").innerText = "Erro ao enviar dados";
    }
  }
</script>
