<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Sequenciamento - Teste</title>
</head>
<body>
  <h2>Status: <span id="status">Aguardando...</span></h2>

  <button onclick="startSequenciamento()">Iniciar Sequenciamento (Jobs fixos)</button>

  <script>
    const userId = "1";
    const jobIds = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12];
    const sequencingDate = "2024-11-22T12:00:00";
    const machineAvailability = 100;

    let source;

    function conectarSSE() {
      if (source) source.close();

      source = new EventSource(`/sequenciamento/sequenciamento/stream?user_id=${userId}`);
      document.getElementById("status").innerText = "Aguardando resposta do servidor...";

      source.onmessage = function(event) {
        document.getElementById("status").innerText = event.data;
        console.log("‚úÖ Evento recebido:", event.data);
      };

      source.onerror = function(error) {
        document.getElementById("status").innerText = "Erro na conex√£o com SSE";
        console.error("‚ùå Erro SSE:", error);
        source.close();
      };
    }

    async function startSequenciamento() {
      conectarSSE();

      try {
        const url = `/sequenciamento/sequenciamento/solve?sequencing_date=${encodeURIComponent(sequencingDate)}&machine_availability=${machineAvailability}`;

        const response = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(jobIds)  // ‚úÖ lista direta ‚Äî ESSENCIAL
        });

        const data = await response.json();

        if (!response.ok) {
          document.getElementById("status").innerText = `Erro: ${JSON.stringify(data)}`;
        } else {
          document.getElementById("status").innerText = `Sequenciamento finalizado. Objetivo: ${data.objective_value}`;
          console.log("üü¢ Resposta da API:", data);
        }

      } catch (err) {
        console.error("‚ùå Erro na requisi√ß√£o:", err);
        document.getElementById("status").innerText = "Erro ao enviar dados";
      }
    }
  </script>
</body>
</html>
